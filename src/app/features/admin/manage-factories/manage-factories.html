<h1 class="page-title">Factories</h1>
<p class="page-sub">Manage factories and linked orders</p>

<div class="header-row">

  @if (isAdmin()) {
    <button class="btn-primary" (click)="startAdd()">üè≠ Add Factory</button>
  }

  <div class="search-box">
    <input
      type="text"
      placeholder="Search..."
      [(ngModel)]="searchText"
      (input)="onSearchChange()" />

    <button class="btn-secondary" (click)="search()">Search</button>
  </div>

</div>

<div class="table-card">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Location</th>
        <th>Details</th>
        @if (isAdmin()) { <th>Actions</th> }
      </tr>
    </thead>

    <tbody>
      @for (f of factories; track f.id) {
        <tr>
          <td>{{ f.id }}</td>
          <td>{{ f.name }}</td>
          <td>{{ f.location }}</td>

          <td>
            <button class="btn-secondary" (click)="showDetails(f.id)">
              View
            </button>
          </td>

          @if (isAdmin()) {
            <td class="actions">
              <button class="btn-edit" (click)="startEdit(f)">Edit</button>
              <button class="btn-delete" (click)="delete(f.id)">Delete</button>
            </td>
          }
        </tr>
      }
    </tbody>
  </table>
</div>

<!-- ===== VIEW FACTORY MODAL ===== -->
@if (selectedFactory) {
<div class="modal-backdrop" (click)="closeFactory()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <button class="close-btn" (click)="closeFactory()">‚úñ</button>

    <div class="factory-header-section">
      <h2>üè≠ {{ selectedFactory.name }}</h2>
      <p class="location-text">üìç {{ selectedFactory.location }}</p>
    </div>

    <div class="orders-header">
      <h4>üì¶ Orders ({{ selectedFactory.orders?.length || 0 }})</h4>
    </div>

    @if (!selectedFactory.orders || selectedFactory.orders.length === 0) {
      <p class="muted">No orders linked</p>
    } @else {
      <div class="order-slider-container">
        <div class="order-slider-wrapper">
          @for (o of selectedFactory.orders; track o.id) {
            <div class="order-card" [class.active]="currentOrderIndex === $index">
              <div class="order-header">
                <div class="order-id-section">
                  <span class="order-label">Order #{{ o.id }}</span>
                  <span class="order-status" [class]="'status-' + (o.status?.toLowerCase() || 'pending')">{{ o.status }}</span>
                </div>
              </div>
              <div class="order-details">
                <div class="detail-row">
                  <span class="detail-icon">üìÖ</span>
                  <div class="detail-content">
                    <span class="detail-label">Date</span>
                    <span class="detail-value">{{ o.orderDate | date:'medium' }}</span>
                  </div>
                </div>
                <div class="detail-row">
                  <span class="detail-icon">‚ôªÔ∏è</span>
                  <div class="detail-content">
                    <span class="detail-label">Material</span>
                    <span class="detail-value">{{ o.typeOfMaterial || 'N/A' }}</span>
                  </div>
                </div>
                <div class="detail-row">
                  <span class="detail-icon">‚öñÔ∏è</span>
                  <div class="detail-content">
                    <span class="detail-label">Quantity</span>
                    <span class="detail-value">{{ o.quantity || 0 }} kg</span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
        
        @if (selectedFactory.orders.length > 1) {
          <button class="order-slider-btn prev" (click)="prevOrder(); $event.stopPropagation()">‚ùÆ</button>
          <button class="order-slider-btn next" (click)="nextOrder(); $event.stopPropagation()">‚ùØ</button>
          
          <div class="order-slider-dots">
            @for (o of selectedFactory.orders; track $index) {
              <span 
                class="order-dot" 
                [class.active]="currentOrderIndex === $index"
                (click)="goToOrder($index); $event.stopPropagation()">
              </span>
            }
          </div>
          
          <div class="order-counter">
            {{ currentOrderIndex + 1 }} / {{ selectedFactory.orders.length }}
          </div>
        }
      </div>
    }

  </div>
</div>
}

<!-- ===== ADD / EDIT MODAL ===== -->
@if (showForm && isAdmin()) {
<div class="modal-backdrop" (click)="closeForm()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <h3 class="modal-title">{{ editing ? '‚úèÔ∏è Edit Factory' : 'üè≠ Add Factory' }}</h3>

    <input type="text" placeholder="Name" [(ngModel)]="form.name">
    <input type="text" placeholder="Location" [(ngModel)]="form.location">

    <div class="modal-actions">
      <button class="btn-save" (click)="save()">
        {{ editing ? 'üíæ Save Changes' : '‚ú® Add Factory' }}
      </button>

      <button class="btn-cancel" (click)="closeForm()">Cancel</button>
    </div>

  </div>
</div>
}
