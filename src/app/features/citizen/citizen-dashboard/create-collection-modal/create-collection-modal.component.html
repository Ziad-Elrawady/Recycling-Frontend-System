@if (open) {
  <div class="fixed inset-0 z-[9998] bg-black/50" (click)="close()"></div>
  <div class="fixed left-0 right-0 top-[70px] z-[9999] flex items-center justify-center p-4 h-[calc(100vh-70px)] overflow-hidden" (click)="close()">
    <div class="bg-card rounded-xl border border-border shadow-2xl w-full max-w-2xl mx-auto max-h-full overflow-y-auto" (click)="$event.stopPropagation()">
      <div class="bg-gradient-to-r from-primary/10 to-primary/5 border-b border-border p-6">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-primary to-primary/80 bg-clip-text text-transparent">üå± {{ ('createRequest') }}</h2>
        <p class="text-sm text-muted-foreground mt-1">Help us recycle and earn rewards!</p>
      </div>
      
      <div class="p-6">

        <form [formGroup]="form" (ngSubmit)="handleSubmit()" class="space-y-8">
          <!-- Step 1: Contact Information -->
          <div class="space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b border-primary/20">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">1</span>
              <h3 class="text-lg font-semibold">Contact Information</h3>
            </div>
            
            <div class="space-y-2">
              <label for="email" class="text-sm font-medium flex items-center gap-2">
                <span>üìß</span> {{ ('email') }} <span class="text-destructive">*</span>
              </label>
              <input
                id="email"
                type="email"
                formControlName="email"
                placeholder="your.email@example.com"
                class="w-full px-4 py-3 border border-input rounded-lg bg-background focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                [class.border-destructive]="form.get('email')?.invalid && form.get('email')?.touched"
              />
              @if (form.get('email')?.invalid && form.get('email')?.touched) {
                <p class="text-xs text-destructive flex items-center gap-1">
                  <span>‚ùå</span> {{ 'Valid email is required' }}
                </p>
              }
            </div>
          </div>

          <!-- Step 2: Material Selection -->
          <div class="space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b border-primary/20">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">2</span>
              <h3 class="text-lg font-semibold">What would you like to recycle?</h3>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              @for (material of materials(); track material.id) {
                <button
                  type="button"
                  (click)="toggleMaterial(material.id)"
                  [class.bg-primary/10]="isSelectedMaterial(material.id)"
                  [class.border-primary]="isSelectedMaterial(material.id)"
                  [class.border-input]="!isSelectedMaterial(material.id)"
                  class="p-4 border-2 rounded-lg cursor-pointer hover:border-primary/50 transition-all duration-200 text-left hover:shadow-md"
                >
                  <div class="text-3xl mb-2">{{ material.icon }}</div>
                  <div class="capitalize font-medium text-sm">{{ (material.label) }}</div>
                  @if (isSelectedMaterial(material.id)) {
                    <div class="text-xs text-primary font-semibold mt-1">‚úì Selected</div>
                  }
                </button>
              }
            </div>
            
            @if (selectedMaterials().length === 0 && form.touched) {
              <div class="p-3 bg-destructive/10 border border-destructive/20 rounded-lg text-sm text-destructive flex items-center gap-2">
                <span>‚ö†Ô∏è</span> {{ ('selectMaterial') }}
              </div>
            }
          </div>

          <!-- Selected Materials with Individual Weights -->
          @if (selectedMaterials().length > 0) {
            <div class="space-y-4">
              <div class="flex items-center gap-3 pb-3 border-b border-primary/20">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">3</span>
                <h3 class="text-lg font-semibold">How much are you recycling?</h3>
              </div>
              
              <div class="space-y-3 p-4 bg-primary/5 rounded-xl border border-primary/20">
                @for (material of selectedMaterials(); let i = $index; track material.id) {
                  <div class="flex items-end gap-3 p-4 bg-background rounded-lg border border-border/50 hover:border-primary/30 transition-colors">
                    <div class="flex-1 space-y-2">
                      <label class="text-sm font-medium text-muted-foreground flex items-center gap-2">
                        <span class="text-lg">{{ material.icon }}</span> 
                        <span class="capitalize">{{ (material.label) }}</span>
                      </label>
                      <input
                        type="number"
                        [value]="getMaterialWeight(material.id)"
                        (change)="setMaterialWeight(material.id, $event)"
                        placeholder="0.0"
                        min="0.1"
                        step="0.1"
                        class="w-full px-3 py-3 border border-input rounded-lg bg-background text-sm font-medium focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                        [class.border-destructive]="getMaterialWeight(material.id) <= 0"
                      />
                      @if (getMaterialWeight(material.id) <= 0) {
                        <p class="text-xs text-destructive flex items-center gap-1">
                          <span>‚ö†Ô∏è</span> {{  'Weight must be greater than 0' }}
                        </p>
                      }
                    </div>
                    <span class="text-sm font-semibold text-primary pb-3 min-w-10">kg</span>
                    <button
                      type="button"
                      (click)="removeMaterial(material.id)"
                      class="p-2 text-destructive hover:bg-destructive/10 rounded-lg transition-colors font-bold text-lg hover:scale-110"
                      title="{{  'Remove' }}"
                    >
                      ‚úï
                    </button>
                  </div>
                }
                
                <div class="pt-4 border-t border-primary/10 mt-4">
                  <div class="flex justify-between items-center bg-primary/5 p-3 rounded-lg">
                    <span class="text-sm font-medium text-muted-foreground">üì¶ {{ 'Total Weight' }}:</span>
                    <span class="font-bold text-primary text-xl">{{ getTotalWeight() }} kg</span>
                  </div>
                  @if (getTotalWeight() <= 0 && selectedMaterials().length > 0) {
                    <p class="text-xs text-destructive mt-2 flex items-center gap-1">
                      <span>‚ö†Ô∏è</span> {{  'Total weight must be greater than 0' }}
                    </p>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Address Section -->
          <div class="space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b border-primary/20">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">4</span>
              <h3 class="text-lg font-semibold">Where should we pick it up?</h3>
            </div>
            
            <div class="space-y-4 p-4 bg-muted/30 rounded-xl border border-border">
              <!-- City -->
              <div class="space-y-2">
                <label for="city" class="text-sm font-medium flex items-center gap-2">
                  <span>üèôÔ∏è</span> {{ ('city') }} <span class="text-destructive">*</span>
                </label>
                <input
                  id="city"
                  type="text"
                  formControlName="city"
                  placeholder="Cairo, Alexandria, etc."
                  class="w-full px-4 py-3 border border-input rounded-lg bg-background focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                  [class.border-destructive]="form.get('city')?.invalid && form.get('city')?.touched"
                />
                @if (form.get('city')?.invalid && form.get('city')?.touched) {
                  <p class="text-xs text-destructive flex items-center gap-1">
                    <span>‚ùå</span> {{  'City is required' }}
                  </p>
                }
              </div>

              <!-- Street -->
              <div class="space-y-2">
                <label for="street" class="text-sm font-medium flex items-center gap-2">
                  <span>üõ£Ô∏è</span> {{ ('street') }} <span class="text-destructive">*</span>
                </label>
                <input
                  id="street"
                  type="text"
                  formControlName="street"
                  placeholder="Main Street, Tahrir Street, etc."
                  class="w-full px-4 py-3 border border-input rounded-lg bg-background focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                  [class.border-destructive]="form.get('street')?.invalid && form.get('street')?.touched"
                />
                @if (form.get('street')?.invalid && form.get('street')?.touched) {
                  <p class="text-xs text-destructive flex items-center gap-1">
                    <span>‚ùå</span> {{  'Street is required' }}
                  </p>
                }
              </div>

              <!-- Building Number -->
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <label for="buildingNo" class="text-sm font-medium flex items-center gap-2">
                    <span>üè¢</span> {{ ('buildingNo') }} <span class="text-destructive">*</span>
                  </label>
                  <input
                    id="buildingNo"
                    type="text"
                    formControlName="buildingNo"
                    placeholder="123"
                    class="w-full px-4 py-3 border border-input rounded-lg bg-background focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                    [class.border-destructive]="form.get('buildingNo')?.invalid && form.get('buildingNo')?.touched"
                  />
                  @if (form.get('buildingNo')?.invalid && form.get('buildingNo')?.touched) {
                    <p class="text-xs text-destructive flex items-center gap-1">
                      <span>‚ùå</span> {{  'Building number is required' }}
                    </p>
                  }
                </div>

                <!-- Apartment (Optional) -->
                <div class="space-y-2">
                  <label for="apartment" class="text-sm font-medium flex items-center gap-2">
                    <span>üö™</span> {{ ('apartment') }} 
                    <span class="text-xs text-muted-foreground font-normal">({{  'optional' }})</span>
                  </label>
                  <input
                    id="apartment"
                    type="text"
                    formControlName="apartment"
                    placeholder="A1"
                    class="w-full px-4 py-3 border border-input rounded-lg bg-background focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ Backend Error Display -->
          @if (submitError()) {
            <div class="p-4 bg-destructive/10 border border-destructive/30 rounded-lg">
              <p class="text-sm text-destructive flex items-center gap-2">
                <span class="text-lg">‚ö†Ô∏è</span> {{ submitError() }}
              </p>
            </div>
          }

          <!-- Summary Card -->
          @if (form.valid && selectedMaterials().length > 0) {
            <div class="p-4 bg-gradient-to-r from-primary/5 to-primary/10 rounded-xl border border-primary/20">
              <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                <span>‚ú®</span> Request Summary
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">üìç Location:</span>
                  <span class="font-medium">{{ form.get('city')?.value }}, {{ form.get('street')?.value }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">‚ôªÔ∏è Total Weight:</span>
                  <span class="font-bold text-primary text-lg">{{ getTotalWeight() }} kg</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">üéÅ Materials:</span>
                  <span class="font-medium">{{ selectedMaterials().length }} type(s)</span>
                </div>
              </div>
            </div>
          }

          <!-- Actions -->
          <div class="flex gap-3 pt-6 border-t border-border sticky bottom-0 bg-background">
            <button
              type="button"
              (click)="close()"
              class="flex-1 inline-flex items-center justify-center rounded-lg text-sm font-semibold transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-muted hover:text-foreground h-12 px-4"
            >
              {{ ('cancel') }}
            </button>
            <button
              type="submit"
              [disabled]="!form.valid || selectedMaterials().length === 0 || getTotalWeight() <= 0 || isSubmitting()"
              class="flex-1 inline-flex items-center justify-center rounded-lg text-sm font-semibold transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:opacity-90 hover:shadow-lg h-12 px-4"
            >
              @if (isSubmitting()) {
                <span class="inline-flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  {{  'Submitting...' }}
                </span>
              } @else {
                <span class="flex items-center gap-2">
                  <span>üöÄ</span> {{ ('submitRequest') }}
                </span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}