<div class="rewards-page">
  <div class="rewards-container">

    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-wrapper">
          <div class="icon-badge">üéÅ</div>
          <div>
<h1 class="page-title">{{ 'REWARDS.TITLE' | translate }}</h1>
<p class="page-subtitle">{{ 'REWARDS.SUBTITLE' | translate }}</p>

          </div>
        </div>
      </div>

      <!-- Stats & Cart Row -->
      <div class="stats-cart-row">
        <!-- Points Card -->
        <div class="stats-card">
          <app-citizen-stats-cards [stats]="stats()"></app-citizen-stats-cards>
        </div>
<!-- Redeemed Gifts Card -->
@if (showRedeemedCard()) {
  <div class="stats-card redeemed-card" (click)="openRedeemedModal()">
    <div class="redeemed-icon">üéÅ</div>

    <div class="redeemed-info">
<span class="redeemed-title">
  {{ 'REWARDS.REDEEMED_TITLE' | translate }}
</span>

<span class="redeemed-count">
  {{ redeemedGifts().length }}
  {{ 'REWARDS.REDEEMED' | translate }}
</span>

    </div>
  </div>
}
  <!-- ‚úÖ Withdraw Available -->
@if (canWithdraw()) {
  <div class="stats-card cashout-card" (click)="openCashout()">
    <div class="redeemed-icon">üíµ</div>

    <div class="redeemed-info">
<span class="redeemed-title">
  {{ 'REWARDS.WITHDRAW' | translate }}
</span>

<span class="redeemed-count">
  {{ userPoints() }}
  {{ 'REWARDS.POINTS_AVAILABLE' | translate }}
</span>

    </div>
  </div>
}


  <!-- üîí Withdraw Locked -->
@if (!canWithdraw()) {
  <div class="stats-card cashout-card disabled">
    <div class="redeemed-icon">üîí</div>

    <div class="redeemed-info">
<span class="redeemed-title">
  {{ 'REWARDS.WITHDRAW_LOCKED' | translate }}
</span>

<span class="redeemed-count">
  {{ 20 - userPoints() }}
  {{ 'REWARDS.PTS_TO_UNLOCK' | translate }}
</span>

    </div>
  </div>
}

        <!-- Cart Button -->
        <button class="cart-button" (click)="openCart()">
          <div class="cart-button-content">
            <div class="cart-icon-wrapper">
              <span class="cart-icon">üõí</span>
              @if (cartItemCount() > 0) {
                <span class="cart-badge-count">{{ cartItemCount() }}</span>
              }
            </div>
            <div class="cart-details">
<span class="cart-label">
  {{ 'REWARDS.MY_CART' | translate }}
</span>

<span class="cart-info">
  {{ cartItemCount() }}
  {{ 'REWARDS.ITEMS' | translate }}
  ¬∑
  {{ cartTotal() }}
  {{ 'REWARDS.POINTS' | translate }}
</span>

            </div>
          </div>
          <span class="cart-arrow">‚Üí</span>
        </button>
      </div>

    </div>

    <!-- Search Section -->
    <div class="search-section">
      <div class="search-wrapper">
        <div class="search-icon">üîç</div>
        <input
          class="search-input"
placeholder="{{ 'REWARDS.SEARCH_PLACEHOLDER' | translate }}"
          [(ngModel)]="searchTerm"
          (keyup.enter)="search()"
          (input)="search()">
        @if (searchTerm) {
          <button class="clear-search-btn" (click)="resetSearch()">‚úï</button>
        }
      </div>
    </div>


    <!-- Toast Notification -->
    @if (showToast) {
      <div class="toast" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
        <div class="toast-icon">
          @if (toastType === 'success') {
            <span>‚úì</span>
          } @else {
            <span>‚úï</span>
          }
        </div>
        <div class="toast-body">
<p class="toast-title">
  {{ toastType === 'success'
      ? ('REWARDS.SUCCESS' | translate)
      : ('REWARDS.ERROR' | translate) }}
</p>
          <p class="toast-message">{{ toastMessage }}</p>
        </div>
        <button class="toast-close" (click)="closeToast()">‚úï</button>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="spinner"></div>
<p>{{ 'REWARDS.LOADING' | translate }}</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && rewards.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üéÅ</div>
<h2 class="empty-title">
  {{ 'REWARDS.EMPTY_TITLE' | translate }}
</h2>
        <p class="empty-description">
          @if (searchTerm) {
{{ 'REWARDS.EMPTY_SEARCH' | translate }}
          } @else {
{{ 'REWARDS.EMPTY_DEFAULT' | translate }}
          }
        </p>
        @if (searchTerm) {
<button class="btn-primary">
  {{ 'REWARDS.CLEAR_SEARCH' | translate }}
</button>
        }
      </div>
    }

    <!-- Rewards Grid -->
    @if (!isLoading && rewards.length > 0) {
      <div class="rewards-grid">
        @for (r of rewards; track r.id) {
          <div class="reward-card" 
               [class.reward-card-available]="canRedeem(r)"
               [class.reward-card-disabled]="!canRedeem(r) || r.stockQuantity === 0">
            
            <!-- Stock Badge -->
            @if (r.stockQuantity === 0) {
{{ 'REWARDS.OUT_OF_STOCK' | translate }}
            } @else if (r.stockQuantity <= 5) {
{{ r.stockQuantity }} {{ 'REWARDS.LEFT' | translate }}!
            }

            <!-- Reward Image -->
            <div class="reward-image">
              <img [src]="r.imageUrl" [alt]="r.name">
            </div>

            <!-- Reward Content -->
            <div class="reward-content">
              <h3 class="reward-name">{{ r.name }}</h3>
              <p class="reward-description">{{ r.description }}</p>

              <!-- Points Badge -->
              <div class="reward-points-badge">
                <span class="points-icon">‚≠ê</span>
                <span class="points-amount">{{ r.requiredPoints }}</span>
  {{ 'REWARDS.POINTS' | translate }}
              </div>

              <!-- Stock Info -->
              <div class="stock-info">
                <span class="stock-icon">üì¶</span>
                <span class="stock-text" 
                      [class.text-danger]="r.stockQuantity === 0"
                      [class.text-warning]="r.stockQuantity > 0 && r.stockQuantity <= 5"
                      [class.text-success]="r.stockQuantity > 5">
{{ r.stockQuantity }} {{ 'REWARDS.IN_STOCK' | translate }}
                </span>
              </div>

              <!-- Cart Button -->
              <button class="cart-action-btn"
                      [class.cart-action-btn-added]="isInCart(r)"
                      [class.cart-action-btn-disabled]="!canRedeem(r) && !isInCart(r)"
                      [disabled]="!canRedeem(r) && !isInCart(r)"
                      (click)="isInCart(r) ? removeFromCart(r) : addToCart(r)">
                @if (isInCart(r)) {
                  <span class="btn-icon">‚úì</span>
<span>{{ 'REWARDS.REMOVE_FROM_CART' | translate }}</span>
                } @else if (r.stockQuantity === 0) {
                  <span class="btn-icon">‚úï</span>
<span>{{ 'REWARDS.OUT_OF_STOCK' | translate }}</span>
                } @else if (userPoints() < r.requiredPoints) {
                  <span class="btn-icon">üîí</span>
<span>
  {{ 'REWARDS.NEED_POINTS' | translate:{ value: (r.requiredPoints - userPoints()) } }}
</span>
                } @else {
                  <span class="btn-icon">+</span>
<span>{{ 'REWARDS.ADD_TO_CART' | translate }}</span>
                }
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Cart Modal -->
@if (showCartModal()) {
  <div class="modal-overlay" (click)="closeCart()"></div>
  <div class="cart-modal">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title">
        <span class="modal-icon">üõí</span>
<h2>{{ 'REWARDS.CART_TITLE' | translate }}</h2>
      </div>
      <button class="modal-close-btn" (click)="closeCart()">‚úï</button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      @if (cart().length === 0) {
        <div class="cart-empty">
          <div class="cart-empty-icon">üõí</div>
<h3>{{ 'REWARDS.CART_EMPTY' | translate }}</h3>
<p>{{ 'REWARDS.CART_EMPTY_DESC' | translate }}</p>
        </div>
      } @else {
        <div class="cart-items">
          @for (item of cart(); track item.id) {
            <div class="cart-item">
              <div class="cart-item-img">
                <img [src]="item.imageUrl" [alt]="item.name">
              </div>
              <div class="cart-item-details">
                <h4>{{ item.name }}</h4>
<p class="cart-item-points">
  ‚≠ê {{ item.requiredPoints }} {{ 'REWARDS.POINTS' | translate }}
</p>
              </div>
              <button class="cart-item-remove" (click)="removeFromCart(item)" title="Remove">
                üóëÔ∏è
              </button>
            </div>
          }
        </div>
      }
    </div>

    <!-- Modal Footer -->
    @if (cart().length > 0) {
      <div class="modal-footer">
        <div class="cart-summary">
          <div class="summary-row">
<span>{{ 'REWARDS.SUMMARY_ITEMS' | translate }}:</span>
            <strong>{{ cartItemCount() }}</strong>
          </div>
          <div class="summary-row summary-total">
<span>{{ 'REWARDS.SUMMARY_TOTAL' | translate }}:</span>
            <strong class="text-primary">{{ cartTotal() }}</strong>
          </div>
          <div class="summary-row">
<span>{{ 'REWARDS.SUMMARY_BALANCE' | translate }}:</span>
            <strong [class.text-success]="cartTotal() <= userPoints()" 
                    [class.text-danger]="cartTotal() > userPoints()">
              {{ userPoints() }}
            </strong>
          </div>
          @if (cartTotal() > userPoints()) {
            <div class="insufficient-points">
‚ö†Ô∏è {{ 'REWARDS.NEED_MORE_POINTS' | translate:{ value: (cartTotal() - userPoints()) } }}
            </div>
          }
        </div>

        <div class="cart-actions">
          <button class="btn-secondary" (click)="clearCart()" [disabled]="cart().length === 0">
  {{ 'REWARDS.CLEAR_CART' | translate }}
          </button>
          <button class="btn-primary" 
                  (click)="redeemCart()"
                  [disabled]="cart().length === 0 || cartTotal() > userPoints() || isCheckingOut()">
            @if (isCheckingOut()) {
              <span class="btn-spinner"></span>
<span>{{ 'REWARDS.PROCESSING' | translate }}</span>
            } @else {
<span>{{ 'REWARDS.REDEEM_ALL' | translate }}</span>
            }
          </button>
        </div>
      </div>
    }
  </div>
}
@if (showRedeemedModal()) {
  <div class="modal-overlay" (click)="closeRedeemedModal()"></div>

  <div class="redeemed-modal">
<h2>üéÅ {{ 'REWARDS.REDEEMED_MODAL_TITLE' | translate }}</h2>
<p>{{ 'REWARDS.REDEEMED_MODAL_DESC' | translate }}</p>

    <div class="redeemed-gifts-grid">
      @for (gift of redeemedGifts(); track gift.id) {
        <div class="redeemed-gift-card"
             (click)="selectedRedeemedGift.set(gift)">
          <img [src]="gift.imageUrl" />
          <h4>{{ gift.name }}</h4>
<span class="gift-badge">{{ 'REWARDS.REDEEMED_BADGE' | translate }}</span>
        </div>
      }
    </div>

    <button class="btn-secondary" (click)="closeRedeemedModal()">
{{ 'REWARDS.CLOSE' | translate }}    </button>
  </div>
}

@if (selectedRedeemedGift()) {
  <div class="modal-overlay"
       (click)="selectedRedeemedGift.set(null)"></div>

  <div class="gift-details-modal">
    <img [src]="selectedRedeemedGift()!.imageUrl" />

    <h2>{{ selectedRedeemedGift()!.name }}</h2>
    <p>{{ selectedRedeemedGift()!.description }}</p>

<div class="gift-message">
  üéâ {{ 'REWARDS.DELIVERY_SUCCESS' | translate }}
</div>

<div class="delivery-info">
  üöö {{ 'REWARDS.DELIVERY_TIME' | translate }}
</div>

<div class="eco-message">
  üå± {{ 'REWARDS.THANK_YOU' | translate }}
</div>

    <button class="btn-primary"
            (click)="selectedRedeemedGift.set(null)">
      {{ 'REWARDS.GOT_IT' | translate }} üëç
    </button>
  </div>
}
@if (showCashoutModal()) {
  <div class="modal-overlay" (click)="closeCashout()"></div>

  <div class="redeemed-modal">
<h2>üíµ {{ 'REWARDS.CASHOUT_TITLE' | translate }}</h2>
    <p class="modal-subtitle">
      {{ 'REWARDS.CASHOUT_DESC' | translate }}
    </p>

    <!-- Wallet Type -->
    <select class="input" [(ngModel)]="walletType">
      <option value="vodafone">Vodafone Cash</option>
      <option value="instapay">InstaPay</option>
      <option value="bank">Bank Account</option>
    </select>

    <!-- Wallet Number -->
    <input
      class="input"
      type="text"
      [(ngModel)]="walletNumber"
placeholder="{{ 'REWARDS.WALLET_PLACEHOLDER' | translate }}"
    />

    <div class="cart-actions">
      <button class="btn-secondary" (click)="closeCashout()">
        {{ 'REWARDS.CANCEL' | translate }}
      </button>

      <button class="btn-primary" (click)="confirmCashout()">
{{ 'REWARDS.CONFIRM' | translate }}      </button>
    </div>
  </div>
}
